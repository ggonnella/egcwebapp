{% block content %}
  {% set record_table="crule" %}
  {% set record_type="C" %}
  {% set table_id="crule-table" %}
  {% if main %}
    {% set prev = 'crule_list' %}
    {% set ancestor_ids = [] %}
  {% else %}
    {% set ancestor_ids_str = ancestor_ids | join(",") %}
    {% set table_id=table_id+"-"+ancestor_ids_str %}
  {% endif %}
  <div id="{{table_id}}-wrapper">
    <table id="{{table_id}}" class="table table-striped table-hover">
      <thead>
        <tr>
          <th>ID</th>
          <th>Sources</th>
          <th>Attribute</th>
          <th>Group 1</th>
          <th>Group 1 Portion</th>
          <th>Operator</th>
          <th>Group 2</th>
          <th>Group 2 Portion</th>
          <th>Tags</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        {% for crule in crules %}
          {% set record_id = crule.id %}
          <tr>
            <td>
              {% if main %}
                {{ crule.id }}
              {% else %}
                {% include 'linked_record_id.html' %}
              {% endif %}
            </td>
            <td>
              {% if crule.source is string %}
                {% set related_table, related_id =
                   'extract', crule.source %}
                {% include 'refs_link.html' %}
              {% else %}
                {% for source in crule.source %}
                  {% set related_table, related_id =
                     'extract', source %}
                  {% include 'refs_link.html' %}
                {% endfor %}
              {% endif %}
            </td>
            <td>
              {% if crule.attribute is string %}
                {% set related_table, related_id =
                   'attribute', crule.attribute %}
                {% include 'refs_link.html' %}
              {% else %}
                {% set related_table, related_id =
                   'attribute', crule.attribute.id1 %}
                {% include 'refs_link.html' %}
                <br/>vs.<br/>
                {% set related_table, related_id =
                   'attribute', crule.attribute.id2 %}
                {% include 'refs_link.html' %}
              {% endif %}
            </td>
            <td>
              {% set related_table, related_id =
                 'group', crule.group1.id %}
              {% include 'refs_link.html' %}
            </td>
            <td>
              {% if crule.group1.portion %}
                {{ crule.group1.portion }}
              {% endif %}
            </td>
            <td>{{ crule.operator }}</td>
            <td>
              {% set related_type, related_id =
                 'group', crule.group2.id %}
              {% include 'refs_link.html' %}
            </td>
            <td>
              {% if crule.group2.portion %}
                {{ crule.group2.portion }}
              {% endif %}
            </td>
            <td>
              {% set record = crule %}
              {% include 'tags_lines.html' %}
            </td>
            <td>
              <a href="{{ url_for('edit_crule', record_id=record_id) }}"><i class="fas fa-edit"></i></a>
              <form action="{{ url_for('delete_crule', record_id=record_id) }}" method="post" style="display: inline-block;">
               <input type="hidden" name="_method" value="DELETE">
                <button type="submit" class="btn btn-link"><i class="fas fa-trash"></i></button>
              </form>
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  <script type="module">
   import { openRelatedNested } from
        '{{ url_for('static', filename='js/nested_table.js') }}';
    $(function() {
      $('body').on('click', '.related-crules-extracts',
            openRelatedNested('crules', 'extracts', 9));
      $('body').on('click', '.related-crules-attributes',
            openRelatedNested('crules', 'attributes', 9));
      $('body').on('click', '.related-crules-groups',
            openRelatedNested('crules', 'groups', 9));
    });
  </script>
  {% if not main %}
    <script type="module">
      import { initNestedTable } from '{{ url_for('static', filename='js/nested_table.js') }}';
      import { initTooltips } from '{{ url_for('static', filename='js/list_crule.mjs') }}';
      $(document).ready(function() {
        initNestedTable("{{table_id}}");
        initTooltips();
      });
    </script>
  {% endif %}
{% endblock %}

